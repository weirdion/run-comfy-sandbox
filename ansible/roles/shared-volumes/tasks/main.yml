---
# Set up directory symlinks using shared group permissions

- name: Ensure primary user AI workspace directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ primary_user }}"
    group: "{{ shared_group }}"
    mode: '2775'
  become: true
  loop:
    - "{{ ai_workspace }}"
    - "{{ ai_workspace }}/comfy"
    - "{{ ai_workspace }}/comfy/workflows"
    - "{{ ai_workspace }}/input"
    - "{{ ai_workspace }}/output"
  # 2775 = setgid bit ensures new files inherit comfyshared group
  # Both users have read/write/execute

- name: Check if models is a symlink (external drive setup)
  ansible.builtin.stat:
    path: "{{ models_source_dir }}"
  register: models_stat

- name: Ensure models directory exists (if not a symlink)
  ansible.builtin.file:
    path: "{{ models_source_dir }}"
    state: directory
    owner: "{{ primary_user }}"
    group: "{{ shared_group }}"
    mode: '2775'
  become: true
  when: not models_stat.stat.exists or not models_stat.stat.islnk
  # Models are 2775: setgid bit ensures new files inherit comfyshared group
  # Both users can write (needed for .sha256, .civitai.info, etc.)

- name: Fix permissions on external drive models (if symlink)
  ansible.builtin.file:
    path: "{{ models_stat.stat.lnk_source }}"
    owner: "{{ primary_user }}"
    group: "{{ shared_group }}"
    mode: '2775'
    recurse: true
  become: true
  when: models_stat.stat.exists and models_stat.stat.islnk
  # If models is symlinked to external drive, fix permissions on target
  # 2775 = group has write access for .sha256 and .civitai.info files

- name: Set group ownership recursively on shared directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ primary_user }}"
    group: "{{ shared_group }}"
    mode: '2775'
    recurse: true
  become: true
  loop:
    - "{{ ai_workspace }}/comfy/workflows"
    - "{{ ai_workspace }}/input"
    - "{{ ai_workspace }}/output"
  # 2775 = setgid bit ensures new files inherit comfyshared group
  # Ensures all files in these directories are accessible to both users
  # Note: models_source_dir handled separately (may be symlink to external drive)

- name: Remove default directories that will be replaced with symlinks
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  become: true
  loop:
    - "{{ comfyui_dir }}/models"
    - "{{ comfyui_dir }}/input"
    - "{{ comfyui_dir }}/output"
    - "{{ comfyui_dir }}/user/default/workflows"
  # Remove ComfyUI's auto-created directories before symlinking

- name: Create symlink for entire models directory
  ansible.builtin.file:
    src: "{{ models_source_dir }}"
    dest: "{{ comfyui_dir }}/models"
    state: link
    force: true
  become: true
  become_user: "{{ sandbox_user }}"
  # Symlink entire models directory (read-only for sandbox)

- name: Ensure parent directories exist for directory symlinks
  ansible.builtin.file:
    path: "{{ item.dest | dirname }}"
    state: directory
    owner: "{{ sandbox_user }}"
    group: staff
    mode: '0755'
  become: true
  loop: "{{ directory_symlinks }}"

- name: Create directory symlinks (workflows, input, output)
  ansible.builtin.file:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    state: link
    force: true
  become: true
  become_user: "{{ sandbox_user }}"
  loop: "{{ directory_symlinks }}"
  # Symlinks to shared read/write directories

- name: Set shared group on sandbox ComfyUI for read access from primary user
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    group: "{{ shared_group }}"
    mode: '2755'
    recurse: true
  become: true
  loop:
    - "{{ comfyui_dir }}"
    - "{{ comfyui_dir }}/custom_nodes"
  # Grant primary user read access to ComfyUI installation for LLM scanning
  # 2755 = setgid bit + read-only for group members

- name: Create symlink to sandbox ComfyUI in primary user workspace
  ansible.builtin.file:
    src: "{{ comfyui_dir }}"
    dest: "{{ ai_workspace }}/ComfyUI"
    state: link
    force: true
  # Allows primary user to access sandbox ComfyUI for security scanning

- name: Display shared volumes info
  ansible.builtin.debug:
    msg: |
      Directory symlinks created using shared group: {{ shared_group }}

      Read/Write (both users - 2775):
      {% for link in directory_symlinks %}
        {{ link.description }}: {{ link.src }} -> {{ link.dest }}
      {% endfor %}

      Read-Only for sandbox (2755):
        Models: {{ models_source_dir }} -> {{ comfyui_dir }}/models

      Read-Only for primary user (2755):
        Sandbox ComfyUI: {{ comfyui_dir }} -> {{ ai_workspace }}/ComfyUI

      Permission model:
        - Primary user ({{ primary_user }}): owns shared files, can read sandbox ComfyUI
        - Shared group ({{ shared_group }}): both users are members
        - Workflows/input/output: 2775 (group has read/write)
        - Models: 2755 (group has read-only)
        - ComfyUI/custom_nodes: 2755 (group has read-only for scanning)
